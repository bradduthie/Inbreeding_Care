---
title: "Inbreeding parents should invest more resources in fewer offspring"
author: "Brad Duthie"
date: "March 28, 2016"
output:
  pdf_document:
    fig_caption: yes
  html_document: default
  word_document:
    fig_caption: yes
    pandoc_args:
    - --csl
    - evolution.csl
header-includes:
- \usepackage{natbib}
- \usepackage{lineno}
- \linenumbers
- \bibliographystyle{amnatnat}
linestretch: 1
csl: evolution.csl
bibliography: Inbreeding_and_PI.bib
---

<!---
- \setlength\parindent{24pt} 
  word_document:
    reference_docx: AASRJ-Style-Format.docx
--->

******************************

<!--- Word count including figures: 4941. Excluding figures: 4627. All but appedix: 5726 All including appendix: 6403 --->

```{r, echo=FALSE}
figscale <- 1.0; # Avoid making huge figures.
```

Background
===================================================

<!--- I want to be as upfront as possible with what I see as the merits of this manuscript because my perceptions on the matter will certainly affect the writing. I do not see the primary theoretical contribution of this paper as relaxing assumptions -- trying to frame the modelling in this context might make the writing easier, but I think it ultimately undersells the theoretical novelty and creativity, and risks making the theoretical knowledge gained sound too incremental. For example, something like ``previous theory assumes PI does not vary with inbreeding, but this is a strong and highly restrictive assumption, so we allow PI to vary and determine the consequences, ultimately discovering that predictions drastically change if parents can vary their PI'' is true, and it highlights major consequences for empirical predictions that are definitely important, but the consequences for theory -- how we think about reproduction and fitness and thereby conceptually unify biological concepts, is missing. I think the conceptual unification needs to be emphasised first and most, and the implications for prediction will (at least, should) follow naturally and intuitively when readers understand the big conceptual ideal. I'm not arguing that the restrictiveness of previous model assumptions shouldn't be mentioned somewhere, just that this isn't the big picture. The big picture is that we have conceptually unified two long-standing but historically disparate theoretical frameworks to derive a near-universal biological law with a *very* minimal set of assumptions. I know I'm a bit odd in finding this kind of thing to be the most inherently exciting part of biology, but I'm definitely not alone (as is evident from the work of other theoreticians). And I think it's these kinds of theoretical acheivements that, in the long-term, drive the biggest and most interesting advances in biology. --->

Natural selection is a universal biological process by which inherited variations tend to be preserved within populations if they increase an individual's survival and reproductive success [@Darwin1859]. Reproduction is therefore central to the evolution and persistence of all populations, and reproductive output classically defines individual fitness [@Dawkins1982]. Over a century after @Darwin1859, Hamilton [-@Hamilton1964; -@Hamilton1964a] identified a key limitation of this classical definition of fitness, recognising that natural selection should more generally act on individual phenotypes to maximise the rate at which individuals spread their identical-by-descent alleles. This more general 'inclusive fitness' identifies the target of natural selection [@Grafen2006], and accounts for both an individual's own reproductive success and that of its relatives with shared identical-by-descent alleles. Inclusive fitness theory provides numerous evolutionary insights [@Gardner2014], perhaps most iconically reconciling self-sacrificial behaviour by appealing to the increased reproductive success of related beneficiaries [@Hamilton1964]. It is less widely appreciated that the reproductive success of relatives can also be increased by inbreeding, and that inbreeding tolerance or preference might therefore be predicted despite decreased fitness of inbred offspring [@Parker1979]. While the inclusive fitness consequences of inbreeding have received some attention [e.g., @Parker2006; @Kokko2006; @Duthie2015a], such theory focuses narrowly on the decision to inbreed or avoid inbreeding. No theory considers the broader context of how parents allocate resources to reproductive output and subsequent parental investment in inbred versus outbred offspring, yet inbreeding might affect selection on reproduction and parental investment because inbreeding simultaneously decreases offspring fitness and increases parent-offspring relatedness. We therefore consider the fitness consequences of inbreeding given variable reproduction and parental investment, and thereby derive a novel hypothesis that broadly affects reproduction across all sexual species. Individuals that inbreed will increase their fitness by increasing their per offspring parental investment and decreasing their total reproductive output, relative to outbreeders.

<!---
Breeding between relatives (inbreeding) can alter offspring genotypes and decrease offspring fitness (inbreeding depression), thereby affecting evolution of phenotypes and population dynamics [@Goodwillie2005; @OGrady2006; @Charlesworth2009]. Evolutionary consequences of inbreeding have been modelled to predict when strategies of inbreeding or avoiding inbreeding will be adaptive [@Parker1979; @Lande1985; @Cheptou2001; @Kokko2006]. Such models assume that parental investment (hereafter PI) does not vary as a consequence of inbreeding [but see @DeJong2005], but if parents can increase their investment in inbred offspring, then it might buffer inbreeding depression and thereby alter selection on inbreeding [@Pilakouta2015]. By conceptually unifying biparental inbreeding and PI theory, we show why PI should increase when offspring are inbred, and we predict the fitness consequences of inbreeding given optimal parental investment.
--->

Biparental inbreeding theory has been primarily developed by extending the basic inclusive fitness model of @Parker1979. In this model, a focal parent encounters a focal relative and chooses to either inbreed or avoid inbreeding with them [e.g., @Parker1979; @Parker2006; @Kokko2006; @Duthie2015a]. If the focal parent inbreeds, then the fitness of the resulting offspring decreases due to inbreeding depression, but the offspring will also carry more identical-by-descent copies of the focal parent's alleles, some of which will have been inherited from the parent's related mate. The focal parent can thereby increase its inclusive fitness by inbreeding if, after accounting for any inbreeding depression in offspring, the proportion of identical-by-descent alleles carried in its inbred offspring exceeds that of outbred offspring. The magnitude of inbreeding depression below which inbreeding rather than avoiding inbreeding increases a parent's inclusive fitness is sex-specific, assuming that females are resource limited and therefore always produce a fixed number of offspring, while males are limited only by mating opportunities (i.e., traditional sex roles). Under such conditions, females can only increase the reproductive success of their male relatives by inbreeding, while males can increase their own reproductive success by inbreeding with negligible costs to reproductive opportunities with other females. Only males are therefore predicted to benefit by inbreeding at high magnitudes of inbreeding depression, while both females and males are predicted to benefit by inbreeding at low magnitudes of inbreeding depression. However, these predictions are sensitive to the assumption that there is a low or negligible opportunity cost of male mating. If inbreeding precludes a male from siring an additional outbred offspring (e.g., as a consequence of strict monogamy), then inbreeding is never beneficial [@Waser1986]. Nevertheless, existing theory that predicts the fitness consequences of inbreeding or avoiding inbreeding given inbreeding depression and male opportunity costs also assumes that parents cannot vary their reproductive output or parental investment in offspring.  

The framework for parental investment (hereafter 'PI') theory is well-established under outbreeding, but how PI and fitness are predicted to change when offspring are inbred remains unexplored. Importantly, PI does not simply represent raw resources provided to an offspring (e.g., food), but is rather anything that a parent does to increase its offspring's fitness at the expense of its other actual or potential offspring [@Trivers1972; @Trivers1974]. One key assumption of PI theory is therefore that the degree to which a parent invests in its offspring is directly and inversely related to the number of offspring that it produces. A second key assumption is that offspring fitness increases with increasing PI, but in such a way as to cause diminishing returns on offspring fitness as more PI is provided. Given these two assumptions, optimal PI for which parental fitness is maximised can be determined; this is usually considered in the context of parent-offspring conflict over investment [e.g., @Macnair1978; @Parker1978; @Parker1985; @DeJong2005; @Kuijper2012]. Models of PI assume that offspring are outbred [or the result of self-fertilisation as in @DeJong2005], but in wild populations inbreeding is both variable and ubiquitous, and directly affects both offspring fitness and parent-offspring relatedness [@OGrady2006; @Charlesworth2009], and therefore might profoundly affect a parent's optimal PI. Yet no theory predicts how parents should adjust their PI given different degrees of inbreeding, or the extent to which adjusting PI can in turn affect parent fitness.

<!--- While @DeJong2005 have modelled such conflict specifically in the context of outcrossed versus self-fertilised seeds, how PI and parental fitness are jointly affected by inbreeding more generally remains unexplored --->

Two additional assumptions are worth considering; both PI and fitness might be affected if investment is shared between parents, or if parents are themselves inbred. For example, while optimal PI and fitness are not expected to differ between single parent investment and monogamous biparental investment given outbreeding [@Parker1985], this might not be the case given inbreeding when monogamy entails a mating opportunity cost [@Waser1986] to a focal female's related male. Additionally, it is unrealistic to assume that focal parents will necessarily be outbred in a population where the opportunity for inbreeding exists. If parents are inbred, it will affect the rate at which they pass identical-by-descent alleles to their offspring [e.g., @Duthie2015a]; hence the consequences of inbred focal parents on PI and parental fitness cannot necessary be ignored. We therefore consider the consequences of biparental investment and inbred focal parents on optimal PI and parent fitness.

Inclusive fitness consequences of inbreeding are well-established, but all models of inbreeding implicitly assume that PI does not vary as a consequence of inbreeding because inbreeding and outbreeding females both produce the same fixed number of offspring. If individuals can vary the number of offspring they produce, and thereby adjust their investment per offspring, then they might be able to mitigate the negative fitness consequences of inbreeding depression with broadly relevant fitness consequences for both inbreeding behaviour and PI. Here we have three specific aims: (1) to show how optimal PI changes when offspring are inbred, and for different magnitudes of inbreeding depression; (2) to show how an inbreeding female's optimal PI is indirectly affected by opportunity costs when both parents invest in offspring; and (3) to show how parental fitness, but not optimal PI, is decreased when an inbreeding female is herself inbred.


******************************

Model
===================================================

<!--- Also, @Parker1985 has a useful way of putting the rate of fitness increase: ``A gene which causes a female to allocate its resources as m* equally to each offspring will have the fastest possible replication rate'' -- maybe explain it this way, with citation, to describe $\zeta_{\textrm{off}}$? Essentially, we are showing how this works when outbreeding is no longer assumed. --->

<!--- Adding a second parent, more generally, is a bit counter-intuitive: Total investment should just be m_mum + m_dad. Given true monogamy under these conditions, optimal investment for each parent is just m*/2 (each contributes half investment). But, if the father slacks off and only invests m*/4 (and mum can't do anything about it), then -- paradoxicially -- mum should invest less, not more. The reason is that given the father decreases its m, the mother is now stuck with more offspring than she would have otherwise produced given her budget for investment; her optimal response is to decrease investment in each. This is because when one parent `defects' by investing less, the reduced benefit is offset by the non-defecting parent (and both parents get the same total benefit) and the defector pays none of the costs. In response, the optimal strategy is therefore to also decrease investment. I'm not sure whether it's worth getting into this or not yet. It appears we would need to define $\zeta_{\textrm{off}}(m1,m2)$, then find 2*zeta(m1)/zeta'(m1) ? --->

Our model conceptually links two different theoretical frameworks initially developed by @Parker1979 and @Macnair1978. The first framework [@Parker1979] predicts inbreeding depression thresholds below which focal parents increase their fitness by inbreeding rather than avoiding inbreeding. The second framework [@Macnair1978] predicts optimal PI in outbred offspring. We consider a focal diploid parent (hereafter assumed to be female) that can adjust the degree to which she invests in each offspring to maximise her own fitness given that she inbreeds to some degree and produces correspondingly inbred offspring whose fitness might be decreased by inbreeding depression.  

<!--- FIXIT: In theory, assumptions (even restrictive ones) are *good* things if they provide conceptual clarity. Sometimes it doesn't (can't) become apparent until later what is being conceptually clarified, which is why it isn't always useful to justify every assumption up front (we also assume no explicit space without justification, but the model would be much worse if we made space explicit because it would detract from the key theoretical point). To assume something in this context isn't to say ''our model is mostly or only relevant if X'', but rather ''to understand our novel theoretical insight, consider the case of X''. Trying to carefully justify a particular assumption at a point like this in the manuscript comes off as warning the reader that the assumption is *really* important to the theoretical insight, rather than a simplifying tool for explaining the theoretical insight. As an extreme, it's kind of like making an argument starting with 'assume you have a fair coin and flip it N times'' -- if you then try to really justify the assumption that the coin can be fair, it gives off the impression that your logic and whatever general conclusions you make will be highly dependent on this assumption, when in fact you might have just been trying to point out something interesting about binomial probability distributions. We're trying to point out something interesting about inbreeding and PI, and assumptions therefore need to be considered in the context of this goal.  --->

We define a focal female's fitness in terms of the rate at which she increases the number of identical-by-descent allele copies carried in her offspring. This definition differs from that of previous models of PI [e.g., @Macnair1978; @Parker1978], which instead define fitness only in terms of the rate at which offspring are produced and therefore cannot account for inclusive fitness differences between inbred and outbred offspring.  As in @Parker1978, we assume that direct offspring fitness (e.g., offspring survival) increases with increasing PI ($m$), with diminishing returns as $m$ increases. Females have a total investment budget of $M$, and therefore will produce $n=M/m$ total offspring. Following @Parker1985, we assume for simplicity that $M \gg m$, but violations of this assumption should not affect our general conclusions. Overall, the number of identical-by-descent allele copies carried per offspring ($\zeta_{\textrm{off}}$) is represented as,

(@maineq) $$ \zeta_{\textrm{off}} = \frac{1}{2}\left(1+r\right)\left(1-e^{-c\left(m-m_{min}-\beta r\right)}\right). $$ 

It is helpful to conceptualise Eq. @maineq in two pieces. First, the expression $\left(1/2\right) \left(1 + r\right)$ is the fitness increment that a female gains from identical-by-descent alleles carried by her offspring, as is affected by the coefficient of relatedness between the female and the sire of her offspring ($r$) scaled by a factor of $1/2$ for each parent's genetic contribution to its offspring. Second, the expression $\left(1 - \exp\left[-c\left(m-m_{min}-\beta r\right)\right]\right)$ is the individual offspring's direct fitness as a function of $m$ and $r$. Additionally, offspring fitness is affected by a minimum value of $m$ required for offspring viability ($m_{min}$), inbreeding depression $\beta$, and a parameter that affects the curve of PI with respect to fitness ($c$; i.e., how 'diminishing' the returns are on $\zeta_{\textrm{off}}$ from increasing $m$). When a focal female inbreeds, the first expression increases because more identical-by-descent alleles are carried by inbred offspring, but the second expression will decrease if $\beta>0$ due to inbreeding depression in those offspring.

When $r=0$ and $\beta=0$ (outbreeding), Eq. @maineq reduces to standard models of PI [e.g., @Macnair1978; @Parker1978] but with the usual parameter $K$ replaced by $1/2$, and thereby specifically representing identical-by-descent alleles instead of an arbitrary constant affecting offspring fitness. Similarly, given $\delta = \exp\left[-c\left(m-m_{min}-\beta r\right)\right]$, where $\delta$ defines reduced fitness of inbred offspring as in previous models of biparental inbreeding [e.g., @Kokko2006; @Parker2006; @Duthie2015a], Eq. @maineq reduces to Parkers [-@Parker1979] standard model of biparental inbreeding.  All offspring have the same direct fitness as $m \to \infty$. Consequently, our model assumes that sufficient PI can always compensate for being inbred, although the amount of investment required for such compensation might be very high (See supporting information for a relaxation of this assumption).

Parental investment and fitness when offspring are inbred
----------------------------------------------------

Equation @maineq can be analysed to determine optimal PI ($m^{*}$), and the rate at which identical-by-descent alleles are passed given $m^{*}$ [@Kuijper2012], which we define as $\gamma^{*}$. An example contrasting outbreeding ($r=0$) with inbreeding between first order relatives ($r=1/2$) illustrates this analysis. For simplicity, we assume that $m_{min}=1$, $\beta=1$, and $c=1$ (see Appendix 1 for sample derivations of $m^{*}$ and $\gamma^{*}$ under these conditions).

```{r, echo=FALSE, fig.width = 6*figscale, fig.height = 8*figscale, fig.cap="(A) Relationship between parental investment and the proportion of a focal female's identical-by-descent alleles that are are carried in its offspring for females that outbreed (solid curve) and females that inbreed with first order relatives (dashed curve). Tangent lines identify optimal parental investment, and their slopes define a female's rate of fitness increase when outbreeding (solid line) and inbreeding (dashed line). Dotted horizontal line shows zero on the y-axis. (B) Relationship between the magnitude of inbreeding depression and optimal parental investment across four degrees of relatedness between a focal female and her mate."}
# Below is a function of the general equation for plotting
OffATr <- function(r, m, mmin=1, Beta=1, c=1){
    return( (1/2)*(1+r) * (1 - exp(-c*(m - mmin - Beta*r)) ));
}
# Below is the same equation as an expression for maths
fm  <- expression(0.5*(1+r)*(1-exp(-c*(m-mmin-Beta*r))),'m');
# We can use the above to differentiate fm wrt `m`
fmd <- D(fm,'m'); # can print fmd to show solution
# Below is fmd for analysis and plotting
OffATrd <- function(r, m, mmin=1, Beta=1, c=1){
    return(  0.5 * (1 + r) * (exp(-c * (m - mmin - Beta * r)) * c)  );
    # Also can simplify: return(  (c/2)*(1+r)*exp(-c*(m-mmin-Beta*r))  );
} # We'll need the above to find m^{*} and \gamma^{*} 
# To find m^{*}, can use the function below
findm <- function(low.guess,high.guess,rval,mmin=1,Beta=1,c=1){
  fm  <- function(m,r=rval){ 
           OffATrd(r=rval, mmin=mmin, Beta=Beta, m=m, c=c)*(0-m) + 
             OffATr(r=rval, mmin=mmin, Beta=Beta, m=m, c=c);
         }
  lg  <- fm(m=low.guess, r=rval);
  hg  <- fm(m=high.guess,r=rval);
  if(lg > 0){
    u <- low.guess;
    l <- high.guess;
  }else{
    u <- high.guess;
    l <- low.guess;
  }
  if((fm(l) > 0 & fm(u) > 0) | (fm(l) < 0 & fm(u) < 0)){
    return("Value of m is outside the range");
  }else{
    check  <- 1;
    mguess <- 0.5 * (l+u);
    i      <- 0;
    while(abs(check) > 0.000001 & i < 1000000){
        check <- fm(r=rval, m=mguess);
        if(check > 0){
          u      <- mguess;
          mguess <- 0.5*(l+mguess); 
        }else{
          l      <- mguess;
          mguess <- 0.5*(u+mguess);
        }
        i <- i+1;
    }
    return(mguess);
  }
} # Running the below returns the estimate
# Below returns m^{*} for outbreeders and inbreeders, respectively
r00m <- findm(low.guess=0,high.guess=4,rval=0.0,mmin=1,Beta=1,c=1);
r05m <- findm(low.guess=0,high.guess=4,rval=0.5,mmin=1,Beta=1,c=1);
# Below finds the tangent slope, \gamma^{*}
r00g <- OffATr(r=0,   m=r00m, mmin=1, Beta=1, c=1) / r00m;
r05g <- OffATr(r=0.5, m=r05m, mmin=1, Beta=1, c=1) / r05m;
# The code below plots everything
PI <- seq(from=0,to=4,by=0.01);
Alleles_IBD_outbr <- OffATr(r=0.0, m=PI, mmin=1, Beta=1, c=1);
Alleles_IBD_inbr  <- OffATr(r=0.5, m=PI, mmin=1, Beta=1, c=1);
# -------------------------------------
r00m.b3 <- findm(low.guess=0,high.guess=6,rval=0.0,mmin=1,Beta=3,c=1);
r05m.b3 <- findm(low.guess=0,high.guess=6,rval=0.5,mmin=1,Beta=3,c=1);
r00g.b3 <- OffATr(r=0,   m=r00m.b3, mmin=1, Beta=3, c=1) / r00m.b3;
r05g.b3 <- OffATr(r=0.5, m=r05m.b3, mmin=1, Beta=3, c=1) / r05m.b3;
bss <- seq(from=0.5,to=5,by=0.25);
gamz <- function(rvl,betas,mmin=1,c=1){
    mvl <- rep(0,length(betas));
    gam <- rep(0,length(betas));
    for(i in 1:length(bss)){
        mvl[i] <- findm(low.guess=0,high.guess=10,rval=rvl,mmin=1,Beta=betas[i],c=1);
        gam[i] <- OffATr(r=rvl, m=mvl[i], mmin=1, Beta=betas[i], c=1) / mvl[i];
    }
    return(list(mvl=mvl,gam=gam));
}
rg000 <- gamz(rvl=0.000,betas=bss);
rg125 <- gamz(rvl=0.125,betas=bss);
rg250 <- gamz(rvl=0.250,betas=bss);
rg500 <- gamz(rvl=0.500,betas=bss);
#-----------------------------------------
par(mfrow=c(2,1),mar=c(5,5,1,1),lwd=2);
layout(matrix(data=c(1,2), nrow=2, ncol=1, byrow = TRUE),
       widths=c(1,1), heights=c(1,1));
# --------------------------------------------------------------------
plot(PI,Alleles_IBD_outbr,type="l",lwd=3,ylim=c(0,1),yaxs="i",xaxs="i",
     xlab=expression(paste("Parental investment (",italic(m),")")),
     ylab=expression(paste("IBD alleles in offspring (",zeta[off],")")),
     cex.lab=1.5,cex.axis=1.5);
abline(h=0,lty="dotted",lwd=0.8);
points(PI,Alleles_IBD_inbr,type="l",lwd=3,lty="dashed");
abline(a=0,b=r00g,lty="solid", lwd=1); # Tangent line r = 0
abline(a=0,b=r05g,lty="dashed",lwd=1); # Tangent line r = 0.5
text(x=0.15,y=0.92,labels="A",cex=2.5);
# --------------------------------------------------------------------
plot(x=bss,y=rg000$mvl,type="l",lwd=2,ylim=c(2,6),pch=1.5,
     xlab=expression(paste("Inbreeding depression (",beta,")")),
     ylab=expression(paste("Optimum PI (",italic(m),"*)")),
     cex.lab=1.5,cex.axis=1.5);
points(x=bss,y=rg125$mvl,type="l",lwd=2);
points(x=bss,y=rg250$mvl,type="l",lwd=2);
points(x=bss,y=rg500$mvl,type="l",lwd=2);
text(x=bss[17],y=rg000$mvl[17]+0.17,labels="r=0",srt=-0,cex=1.25);
text(x=bss[17],y=rg125$mvl[17]+0.2,labels="r=1/8",srt=6,cex=1.25);
text(x=bss[17],y=rg250$mvl[17]+0.2,labels="r=1/4",srt=12.5,cex=1.25);
text(x=bss[17],y=rg500$mvl[17]+0.2,labels="r=1/2",srt=18,cex=1.25);
text(x=0.5,y=5.80,labels="B",cex=2.5);
```

```{r, echo=FALSE}
OffAT <- function(r, m, B0=1, B1=1, c=1){
    return( (1/2)*(1+r) * (1 - exp(-c*(m - B0 - B1*r)) ));
}
```

Figure 1 shows how $\zeta_{\textrm{off}}$ increases with $m$ given $r=0$ (solid curve) and $r=1/2$ (dashed curve). Given $r=0$, $\zeta_{\textrm{off}}=0$ when $m \leq m_{min}$, meaning that offspring are only viable when $m>m_{min}$. Increasing $r$ effectively increases the minimum amount of PI required to produce a viable offspring to $m_{min}+\beta r$, so when $r=1/2$, $\zeta_{\textrm{off}}=0$ when $m \leq 3/2$. Nevertheless, because inbred offspring carry more of their parents' alleles identical-by-descent, sufficiently high $m$ causes $\zeta_{\textrm{off}}$ of inbred offspring to exceed that of outbred offspring (represented by the intersection between solid and dashed curves in Figure 1). The point on the line running through the origin that is tangent to $\zeta_{\textrm{off}}(m)$ defines optimal investment for outbreeding $m^{*}_{r=0}=$ `r round(r00m,digits=3)` (solid line) and inbreeding $m^{*}_{r=1/2}=$ `r round(r05m,digits=3)` (dashed line) parents. The slope of each line is the rate of a parent's fitness increase given outbreeding $\gamma^{*}_{r=0}=$ `r round(r00g,digits=3)` (solid line) and inbreeding $\gamma^{*}_{r=1/2}=$ `r round(r05g,digits=3)` (dashed line). To maximise fitness, females that inbreed with first order relatives ($r=1/2$) should therefore invest more in offspring than females that outbreed ($m^{*}_{r=1/2}>m^{*}_{r=0}$). This result is general across different values of $r$ (see Appendix 2); as $r$ increases, so does $m^{*}$. All else being equal, females that inbreed more should therefore invest more per capita in fewer total offspring.

Assuming that females adopt an optimal strategy of PI, the rate of fitness increase for females can be compared across different degrees of inbreeding $r$ and inbreeding depression $\beta$. In the example above comparing $r=0$ and $r=1/2$ when $\beta=1$, inbreeding increases fitness more than outbreeding when both females invest optimally ($\gamma^{*}_{r=1/2}>\gamma^{*}_{r=0}$). This can also be confirmed by reducing our model to the results of established biparental inbreeding models (see Appendix 3). If, however, $\beta=3$ instead of $\beta=1$, then $\gamma^{*}_{r=0}=$ `r round(r00g.b3,digits=3)` and $\gamma^{*}_{r=1/2}=$ `r round(r05g.b3,digits=3)`. Given this higher inbreeding depression and assuming optimal PI, outbreeding females therefore have higher fitness than females that inbreed with first order relatives.

```{r, echo=FALSE, fig.width = 4*figscale, fig.height = 8*figscale, fig.cap="Relationship between the magnitude of inbreeding depression and the rate of a focal female's fitness increase across four degrees of relatedness between a focal female and her mate assuming that (A) focal females invest optimally given their degree of inbreeding, (B) females invest at the optimum for outbreeding, and (C) females invest at the optimum for inbreeding first order relatives (r=1/2)."}
# Find gamma assuming investing as if outbreeding
gamznokin <- function(rvl,betas,mmin=1,c=1){
    mvl <- rep(0,length(betas));
    gam <- rep(0,length(betas));
    for(i in 1:length(bss)){
        mvl[i] <- findm(low.guess=0,high.guess=10,rval=0,mmin=1,Beta=betas[i],c=1);
        gam[i] <- OffATr(r=rvl, m=mvl[i], mmin=1, Beta=betas[i], c=1) / mvl[i];
    }
    return(list(mvl=mvl,gam=gam));
}
rg000nk <- gamznokin(rvl=0.000,betas=bss);
rg125nk <- gamznokin(rvl=0.125,betas=bss);
rg250nk <- gamznokin(rvl=0.250,betas=bss);
rg500nk <- gamznokin(rvl=0.500,betas=bss);
# Find gamma assuming investing as if full sibling inbreeding
gamzfsib <- function(rvl,betas,mmin=1,c=1){
    mvl <- rep(0,length(betas));
    gam <- rep(0,length(betas));
    for(i in 1:length(bss)){
        mvl[i] <- findm(low.guess=0,high.guess=10,rval=0.5,mmin=1,Beta=betas[i],c=1);
        gam[i] <- OffATr(r=rvl, m=mvl[i], mmin=1, Beta=betas[i], c=1) / mvl[i];
    }
    return(list(mvl=mvl,gam=gam));
}
rg000fs <- gamzfsib(rvl=0.000,betas=bss);
rg125fs <- gamzfsib(rvl=0.125,betas=bss);
rg250fs <- gamzfsib(rvl=0.250,betas=bss);
rg500fs <- gamzfsib(rvl=0.500,betas=bss);
#--- Start building the figure below
par(mfrow=c(3,1),mar=c(0.25,5,1,1),lwd=2);
#----------------------------------------------------------------
par(mar=c(0.5,5,0.25,1),lwd=2);
plot(x=bss,y=rg000$gam,type="l",lwd=2,ylim=c(0.09,0.22),pch=1.5,yaxt="n",
     ylab="",xaxt="n",cex.lab=1.5,cex.axis=1.5);
axis(side=2,at=c(0.10,0.15,0.20),cex.axis=1.5);
points(x=bss,y=rg125$gam,type="l",lwd=2);
points(x=bss,y=rg250$gam,type="l",lwd=2);
points(x=bss,y=rg500$gam,type="l",lwd=2);
text(x=bss[18],y=rg000$gam[18]+0.0036,labels="r=0",srt=-0,cex=1);
text(x=bss[18],y=rg125$gam[18]+0.0036,labels="r=1/8",srt=-7,cex=1);
text(x=bss[18],y=rg250$gam[18]+0.0036,labels="r=1/4",srt=-9,cex=1);
text(x=bss[18],y=rg500$gam[18]+0.0036,labels="r=1/2",srt=-12,cex=1);
text(x=4.95,y=0.215,labels="A",cex=2.5);
#----------------------------------------------------------------
par(mar=c(0.5,5,0.25,1),lwd=2);
plot(x=bss,y=rg000nk$gam,type="l",lwd=2,ylim=c(0.09,0.22),pch=1.5,yaxt="n",
     ylab=expression(paste("Rate of fitness increase (",gamma,"*)")),
     xaxt="n",cex.lab=1.5,cex.axis=1.5);
axis(side=2,at=c(0.10,0.15,0.20),cex.axis=1.5);
points(x=bss,y=rg125nk$gam,type="l",lwd=2);
points(x=bss,y=rg250nk$gam,type="l",lwd=2);
points(x=bss,y=rg500nk$gam,type="l",lwd=2);
text(x=bss[12],y=rg000nk$gam[12]+0.004,labels="r=0",srt=-0,cex=1);
text(x=bss[10],y=rg125nk$gam[10]+0.004,labels="r=1/8",srt=-16,cex=1);
text(x=bss[7],y=rg250nk$gam[7]+0.005,labels="r=1/4",srt=-40,cex=1);
text(x=bss[4]+0.075,y=rg500nk$gam[4]+0.002,labels="r=1/2",srt=-65,cex=1);
text(x=4.95,y=0.215,labels="B",cex=2.5);
#----------------------------------------------------------------
par(mar=c(5,5,0.25,1),lwd=2);
plot(x=bss,y=rg000fs$gam,type="l",lwd=2,ylim=c(0.09,0.22),pch=1.5,yaxt="n",
     xlab=expression(paste("Inbreeding depression (",beta,")")),
     ylab="",cex.lab=1.5,cex.axis=1.5);
axis(side=2,at=c(0.10,0.15,0.20),cex.axis=1.5);
points(x=bss,y=rg125fs$gam,type="l",lwd=2);
points(x=bss,y=rg250fs$gam,type="l",lwd=2);
points(x=bss,y=rg500fs$gam,type="l",lwd=2);
text(x=bss[3],y=rg000fs$gam[3]+0.005,labels="r=0",srt=-15,cex=1);
text(x=bss[3],y=rg125fs$gam[3]+0.005,labels="r=1/8",srt=-18,cex=1);
text(x=bss[3],y=rg250fs$gam[3]+0.005,labels="r=1/4",srt=-22,cex=1);
text(x=bss[3],y=rg500fs$gam[3]+0.006,labels="r=1/2",srt=-33,cex=1);
text(x=4.95,y=0.215,labels="C",cex=2.5);
#----------------------------------------------------------------
# Next, the below generates a function to find where lines intersect
# Finds the beta at which a particular r value intersects r=0 for fitness
findbeta <- function(high.guess,rval,m=FALSE,mmin=1,c=1){
    low.guess <- 0;
    outbr <- findm(low.guess=0,high.guess=10,rval=0,mmin=mmin,Beta=0,c=c);
    outgm <- OffATr(r=0,m=outbr,mmin=mmin,Beta=0,c=c) / outbr;
    if(m == FALSE){ # If we're not constraining m
        check  <- 1;
        bguess <- 0.5 * high.guess;
        i      <- 0;
        l      <- low.guess
        u      <- high.guess;
        while(abs(check) > 0.000001 & i < 1000000){
            mst   <- findm(low.guess=0,high.guess=10,rval=rval,mmin=mmin,Beta=bguess,c=c);
            gam   <- OffATr(r=rval,m=mst,mmin=mmin,Beta=bguess,c=c) / mst;
            check <- gam - outgm;
            if(check < 0){
                u      <- bguess;
                bguess <- 0.5*(l+bguess); 
            }else{
                l      <- bguess;
                bguess <- 0.5*(u+bguess);
            }
            i <- i+1;
        }
    }else{ #If we are forcing m to a particular value
        check  <- 1;
        bguess <- 0.5 * high.guess;
        i      <- 0;
        l      <- low.guess
        u      <- high.guess;
        while(abs(check) > 0.000001 & i < 1000000){
            gam   <- OffATr(r=rval,m=m,mmin=mmin,Beta=bguess,c=c) / m;
            check <- gam - outgm;
            if(check < 0){
                u      <- bguess;
                bguess <- 0.5*(l+bguess); 
            }else{
                l      <- bguess;
                bguess <- 0.5*(u+bguess);
            }
            i <- i+1;
        }
    }   
    return(bguess);
}

```

<!--- FIXIT: I think one of the reasons I dislike this three panel figure above, and things like it, is that if the reader gets anything out of it, they only do so *because* they're not entirely getting the point. We should be focused on getting readers to undersand the point of *how* to think differently about inbreeding and PI, not *what* to think for different and highly specific situations. Of course fitness goes down when individuals are investing away from their optimum (and at the optimum for a different r). That's just what optimum means -- if panel C fills a knowledge gap, it's because the reader has missed something that we're not addressing (and won't have addressed by showing this figure). Note, panel B is *only* (mildly) interesting because of the magnitude of the shift in fitness -- it is obvious that the downward shift happens (whenever r!=0) by this point, or at least it needs to be; if this comes as a surprise, then the reader isn't connecting the model with the theory. Readers need to see how and why fitness is maximised generally; when they do, details (especially as in panel C) become redundant because the concepts are clear and the biology thereby becomes intuitive. It's worth remembering that gamma, beta, and 'm' are defined *deliberately* to be conceptually easy to deal with, not in such a way as to connect them quantitatively with any real system quantity (if desired, these details can be left to other papers once we clearly explain the key concept in this paper). I think that it's very, very important not to lose the forest for the trees (i.e., the theory for the model) -- focus on the key point (the very general conclusions that can be made with a minimum set of assumptions) and not 'what happens if X, Y, or Z' details of the model. As such, I'm in favour of either removing panel C, or putting it as supporting information (though, again, it really shouldn't be that supportive). We seem to already be going down the route of simply describing what happens in a lot of different situations, rather than explaining how to think about something theoretically novel and interesting and permeates across all of these situations.     --->

A general relationship between $\beta$, $m^{*}$, and $\gamma^{*}$ for different values of $r$ can be shown through numerical simulation. In Fig. 2, this relationship is shown across a range of $\beta$ for $r$ values corresponding to outbreeding ($r=0$) and inbreeding between outbred cousins ($r=1/8$), half-siblings ($r=1/4$), and full siblings ($r=1/2$). Across all numerical simulations, $m_{min}=1$ and $c=1$. Figure 2A shows how $m^{*}$ increases with both increasing $\beta$ and increasing $r$, and Fig. 2B shows how $\gamma^{*}$ changes with $\beta$ and $r$ given optimal PI. Overall, optimal PI increases with increasing inbreeding depression and inbreeding, and the difference in magnitude of investment per offspring is often expected to be high for individuals that inbreed rather than outbreed (e.g., when $\beta=3.25$, $m^{*}_{r=1/2} > m^{*}_{r=0}$ by a factor of `r round(findm(low.guess=0,high.guess=5,rval=0.5,Beta=3.25) / findm(low.guess=0,high.guess=5,rval=0.0,Beta=3.25),digits=2)`). Consequently, inbreeding parents might often be expected to invest considerably more in fewer offspring, relative to outbreeding parents.

<!--- fig.cap="Relationship between inbreeding depression and a focal female's rate of fitness increase when she is assumed to invest at the optimal magnitude for outbred offspring across four degrees of relatedness between the focal female and her mate. Because optimal parental investment is higher for outbred than inbred offspring, rates of fitness increase are lower than would be expected under optimal parental investment for each degree of relatedness --->

In some populations, females might be unable to discriminate between relatives and non-relatives, and hence unable to adjust their PI when inbreeding. It is therefore interesting to consider the fitness consequencies when inbreeding females invest suboptimally in offspring, and therefore $\gamma < \gamma^{*}$. Figure 3 shows $\gamma$ values for inbreeding females when they invest at the relatively low optimum $m^{*}$ for an outbreeding female. The fitness consequences of suboptimal PI are severe when inbreeding females invest as if they are outbreeding (Fig. 3). While the fitness of a female that inbreeds with a first order relative ($r=1/2$) exceeds that of an outbreeding female ($\gamma^{*}=$ `r round(r00g,digits=3)`) when $\beta <$ `r round(findbeta(high.guess=10,rval=0.5,m=FALSE), digits=3)`, if the inbreeding female invests at the outbreeding female's optimum ($m^{*}_{r=0}$), then her fitness is higher only when $\beta <$ `r round(findbeta(high.guess=10,rval=0.5,m=r00m), digits=3)`. Consequently, if parents are unable to adjust their PI with inbreeding, their fitness might be decreased severely relative to optimally investing parents.


```{r, echo=FALSE, fig.width = 8*figscale, fig.height = 5*figscale, fig.cap="A focal female's rate of fitness increase (gamma star), defined as the rate at which she increases the numuber of identical-by-descent alleles copies carried in her offspring, given different magnitudes of parental investment. Lines show outbreeding (r=0), inbreeding between outbred first cousins (r=1/8), half-siblings (r=1/4), and full-siblings (r=1/2). Grey dots identify optimal parental investment (m star) for each degree of inbreeding given magnitudes of inbreeding depression in which inbreeding (A; beta=1) and outbreeding (B; beta=3) increase parent fitness."}
par(oma=c(4,1,1,1));
moBB <- 1;
mvals   <- seq(from=1, to=6, by=0.01);
par(mfrow=c(1,2),mar=c(1,5,2,1),lwd=2);
# First assume that Beta = 1.
mvr000  <- OffATr(r=0.000, m=mvals, mmin=1, Beta=moBB, c=1) / mvals;
mvr125  <- OffATr(r=0.125, m=mvals, mmin=1, Beta=moBB, c=1) / mvals;
mvr250  <- OffATr(r=0.250, m=mvals, mmin=1, Beta=moBB, c=1) / mvals;
mvr500  <- OffATr(r=0.500, m=mvals, mmin=1, Beta=moBB, c=1) / mvals;
mstr000 <- findm(low.guess=0,high.guess=6,rval=0.000,Beta=moBB,c=1,mmin=1);
mstr125 <- findm(low.guess=0,high.guess=6,rval=0.125,Beta=moBB,c=1,mmin=1);
mstr250 <- findm(low.guess=0,high.guess=6,rval=0.250,Beta=moBB,c=1,mmin=1);
mstr500 <- findm(low.guess=0,high.guess=6,rval=0.500,Beta=moBB,c=1,mmin=1);
mstrgm0 <- OffATr(r=0.000, m=mstr000, mmin=1, Beta=moBB, c=1) / mstr000;
mstrgm1 <- OffATr(r=0.125, m=mstr125, mmin=1, Beta=moBB, c=1) / mstr125;
mstrgm2 <- OffATr(r=0.250, m=mstr250, mmin=1, Beta=moBB, c=1) / mstr250;
mstrgm5 <- OffATr(r=0.500, m=mstr500, mmin=1, Beta=moBB, c=1) / mstr500;
plot(x=mvals,y=mvr000,type="l",lwd=3,ylim=c(0.0,0.21),pch=1.5,yaxt="n",
     ylab=expression(paste("Rate of fitness increase (",gamma,"*)")),
     cex.lab=1.5,cex.axis=1.5,xaxs="i",yaxs="i",xaxt="n");
axis(side=2,at=c(0,0.05,0.10,0.15,0.20),labels=TRUE,cex.axis=1.5);
axis(side=1,at=c(1,2,3,4,5,6),cex.axis=1.5);
points(x=mvals,y=mvr125,type="l",lwd=3);
points(x=mvals,y=mvr250,type="l",lwd=3);
points(x=mvals,y=mvr500,type="l",lwd=3);
points(x=mstr000,y=mstrgm0,cex=1.5,pch=21,bg="grey70");
points(x=mstr125,y=mstrgm1,cex=1.5,pch=21,bg="grey70");
points(x=mstr250,y=mstrgm2,cex=1.5,pch=21,bg="grey70");
points(x=mstr500,y=mstrgm5,cex=1.5,pch=21,bg="grey70");
text(x=mvals[450],y=mvr000[450]+0.005,labels="r=0",  srt=-25,cex=0.8);
text(x=mvals[450],y=mvr125[450]+0.005,labels="r=1/8",srt=-25,cex=0.8);
text(x=mvals[450],y=mvr250[450]+0.005,labels="r=1/4",srt=-25,cex=0.8);
text(x=mvals[450],y=mvr500[450]+0.006,labels="r=1/2",srt=-30,cex=0.8);
text(x=5.0,y=0.198,labels=expression(paste("A; ",beta==1)),cex=1.5);
lines(x=c(4.1,4.1,6),y=c(0.21,0.189,0.189),lwd=2);
#--- Now show the place where Beta = 3.
par(mar=c(1,1,2,4),lwd=2);
moBB    <- 3;
mvr000  <- OffATr(r=0.000, m=mvals, mmin=1, Beta=moBB, c=1) / mvals;
mvr125  <- OffATr(r=0.125, m=mvals, mmin=1, Beta=moBB, c=1) / mvals;
mvr250  <- OffATr(r=0.250, m=mvals, mmin=1, Beta=moBB, c=1) / mvals;
mvr500  <- OffATr(r=0.500, m=mvals, mmin=1, Beta=moBB, c=1) / mvals;
mstr000 <- findm(low.guess=0,high.guess=6,rval=0.000,Beta=moBB,c=1,mmin=1);
mstr125 <- findm(low.guess=0,high.guess=6,rval=0.125,Beta=moBB,c=1,mmin=1);
mstr250 <- findm(low.guess=0,high.guess=6,rval=0.250,Beta=moBB,c=1,mmin=1);
mstr500 <- findm(low.guess=0,high.guess=6,rval=0.500,Beta=moBB,c=1,mmin=1);
mstrgm0 <- OffATr(r=0.000, m=mstr000, mmin=1, Beta=moBB, c=1) / mstr000;
mstrgm1 <- OffATr(r=0.125, m=mstr125, mmin=1, Beta=moBB, c=1) / mstr125;
mstrgm2 <- OffATr(r=0.250, m=mstr250, mmin=1, Beta=moBB, c=1) / mstr250;
mstrgm5 <- OffATr(r=0.500, m=mstr500, mmin=1, Beta=moBB, c=1) / mstr500;
plot(x=mvals,y=mvr000,type="l",lwd=3,ylim=c(0.0,0.21),pch=1.5,yaxt="n",
     xlab="",ylab="", cex.lab=1.5,cex.axis=1.5,xaxs="i",yaxs="i",xaxt="n");
axis(side=1,at=c(1,2,3,4,5,6),cex.axis=1.5);
points(x=mvals,y=mvr125,type="l",lwd=3);
points(x=mvals,y=mvr250,type="l",lwd=3);
points(x=mvals,y=mvr500,type="l",lwd=3);
points(x=mstr000,y=mstrgm0,cex=1.5,pch=21,bg="grey70");
points(x=mstr125,y=mstrgm1,cex=1.5,pch=21,bg="grey70");
points(x=mstr250,y=mstrgm2,cex=1.5,pch=21,bg="grey70");
points(x=mstr500,y=mstrgm5,cex=1.5,pch=21,bg="grey70");
text(x=mvals[450],y=mvr000[450]+0.005,labels="r=0",  srt=-22,cex=0.8);
text(x=mvals[450],y=mvr125[450]+0.005,labels="r=1/8",srt=-22,cex=0.8);
text(x=mvals[450],y=mvr250[450]+0.005,labels="r=1/4",srt=-22,cex=0.8);
text(x=mvals[450],y=mvr500[450]+0.005,labels="r=1/2",srt=-22,cex=0.8);
text(x=5.0,y=0.198,labels=expression(paste("B; ",beta==3)),cex=1.5);
lines(x=c(4.1,4.1,6),y=c(0.21,0.189,0.189),lwd=2);
mtext(expression(paste("Parental investment (",italic(m),")")),
      outer=TRUE,side=1,line=2.1,cex=1.5);
```

Effects of biparental investment
------------------------------------------------

```{r, echo=FALSE}
# New equations needed to present the results below
fpair <- expression(0.5*(1+r)*(1-exp(-c*(m-mmin-Beta*r))) - 
                        (r/2)*(1-exp(-c*(z-mmin))),'m');
fpaird <- D(fpair,'m'); # can print fmd to show solution
Offpair <- function(r, m, mmin=1, Beta=1, c=1, m0=r00m){
    direct   <- (1/2)*(1+r) * (1 - exp(-c*(m - mmin - Beta*r)) );
    indirect <- (r/2)*(1-exp(-c*(r00m-mmin)));
    return( direct - indirect);
}
findmpair <- function(low.guess,high.guess,rval,mmin=1,Beta=1,c=1,m0=r00m){
    # Note that derivative of zeta has not changed, only the original f
    fm  <- function(m,r=rval){ 
        OffATrd(r=rval, mmin=mmin, Beta=Beta, m=m, c=c)*(0-m) + 
            Offpair(r=rval, mmin=mmin, Beta=Beta, m=m, c=c, m0=m0);
    }
    lg  <- fm(m=low.guess, r=rval);
    hg  <- fm(m=high.guess,r=rval);
    if(lg > 0){
        u <- low.guess;
        l <- high.guess;
    }else{
        u <- high.guess;
        l <- low.guess;
    }
    if((fm(l) > 0 & fm(u) > 0) | (fm(l) < 0 & fm(u) < 0)){
        return("Value of m is outside the range");
    }else{
        check  <- 1;
        mguess <- 0.5 * (l+u);
        i      <- 0;
        while(abs(check) > 0.000001 & i < 1000000){
            check <- fm(r=rval, m=mguess);
            if(check > 0){
                u      <- mguess;
                mguess <- 0.5*(l+mguess); 
            }else{
                l      <- mguess;
                mguess <- 0.5*(u+mguess);
            }
            i <- i+1;
        }
        return(mguess);
    }
} # Running the below returns the
r05mpB0 <- findmpair(low.guess=0,high.gues=10,rval=0.5,Beta=0);
r05gpB0 <- Offpair(r=0.5, m=r05mpB0, mmin=1, Beta=0, c=1, m0=r00m) / r05mpB0;
r05mpB1 <- findmpair(low.guess=0,high.gues=10,rval=0.5,Beta=1);
r05gpB1 <- Offpair(r=0.5, m=r05mpB1, mmin=1, Beta=1, c=1, m0=r00m) / r05mpB1;

```

We have assumed that only a focal female invests in offspring. The consequence of relaxing this assumption is straightforward in the case of outbreeding if both females and males pair exactly once in life [i.e., strict monomgamy; see @Parker1985]. In this case, $m^{*}$ will remain unchanged with twice as many offspring produced due to a doubled investment budget $2M$ [@Parker1985]. This is not necessarily true given inbreeding because by choosing a male relative, a focal female might be precluding him from mating with another female, as occurs when male mating opportunity costs are high [@Waser1986]. A focal female will then lose any indirect fitness increment that she would have otherwise received from him breeding with a different female. In the biparental inbreeding literature, this indirect fitness loss is modelled as an opportunity cost to the focal male relative [@Waser1986]. To incorporate this cost, it is now necessary to consider both the direct and indirect (through her male relative) fitness consequences of inbreeding explicitly. We assume that if a focal female avoids inbreeding, her male relative will instead outbreed, and that parents invest optimally for any given $\beta$; we define $m^{*}_{0}$ as optimal investment for outbreeding and $m^{*}_{r}$ as optimal investment for inbreeding to the degree $r$. Therefore, if a focal female avoids inbreeding,

(@optPI) $$\zeta_{\textrm{off}} = \frac{1}{2}\left(1-e^{-c\left(m^{*}_{0}-m_{min}\right)}\right).$$ 

Assuming that $c=1$ and $m_{min}=1$, $m^{*}_{0}=$ `r round(r00m,digits=3)`. If she instead inbreeds,

(@optPIoc) $$\zeta_{\textrm{off}} = \frac{1}{2}\left(1+r\right)\left(1-e^{-c\left(m^{*}_{r}-m_{min}-\beta r\right)}\right) - \frac{r}{2}\left(1-e^{-c\left(m^{*}_{0}-m_{min}\right)}\right).$$ 

The first term of Eq. @optPIoc represents the fitness increment the focal female receives from inbreeding (it is identical to Eq. @maineq), while the second term represents the indirect loss of fitness that she would have otherwise received through her relative had she not mated with him. The decrease in $\zeta_{\textrm{off}}(m_{r})$ caused by this fitness loss causes an overall increase in $m^{*}_{r}$. Biologically, monogamous parents should therefore each invest even more per offspring when inbreeding than when females alone invest, assuming a male could have otherwise outbred. For example, if $r=1/2$ and $\beta=1$, $m^{*}_{r}=$ `r round(r05mpB1,digits=3)` given strict monogamy, instead of `r round(r05m,digits=3)` when only the female invests.  However, while $\gamma^{*}_{r=1/2}=$ `r round(r05g,digits=3)` given only female PI, $\gamma^{*}_{r=1/2}=$ `r round(r05gpB1,digits=3)` given strict monogamy, and is therefore less than the fitness increase from outbreeding, $\gamma^{*}_{r=0}=$ `r round(r00g,digits=3)`. Across all values of $\beta$, in fact, $\gamma^{*}_{r=1/2} < \gamma^{*}_{r=0}$ given strict monogamy, meaning that the rate of fitness increase from inbreeding never exceeds outbreeding.

```{r, echo=FALSE, fig.width = 6*figscale, fig.height = 8*figscale, fig.cap="Assuming strict monogamy, the (A) relationship between parental investment and the proportion of a focal female's identical-by-descent alleles that are are carried in its offspring for females that outbreed (solid curve) and females that inbreed with first order relatives (dashed curve). Tangent lines identify optimal parental investment, and their slopes define a female's rate of fitness increase when outbreeding (solid line) and inbreeding (dashed line). Dotted horizontal line shows zero on the y-axis. (B) Relationship between the magnitude of inbreeding depression and optimal parental investment across four degrees of relatedness between a focal female and her mate."}
#---------------- Some general patterns now plotted
bss <- seq(from=0.5,to=5,by=0.25);
gamzp <- function(rvl,betas,mmin=1,c=1,m0=r00m){
    mvl <- rep(0,length(betas));
    gam <- rep(0,length(betas));
    for(i in 1:length(bss)){
        mvl[i] <- findmpair(low.guess=0,high.guess=10,rval=rvl,
                            mmin=1,Beta=betas[i],c=1,m0=r00m);
        gam[i] <- Offpair(r=rvl,m=mvl[i],mmin=1,Beta=betas[i],c=1,m0=m0) / mvl[i];
    }
    return(list(mvl=mvl,gam=gam));
}
rg000p <- gamzp(rvl=0.000,betas=bss);
rg125p <- gamzp(rvl=0.125,betas=bss);
rg250p <- gamzp(rvl=0.250,betas=bss);
rg500p <- gamzp(rvl=0.500,betas=bss);
#----------------------------------------------------------------
Alleles_IBD_outbr_pair <- Offpair(r=0.0, m=PI, mmin=1, Beta=1, c=1);
Alleles_IBD_inbr_pair  <- Offpair(r=0.5, m=PI, mmin=1, Beta=1, c=1);
#-----------------------------------------
par(mfrow=c(2,1),mar=c(5,5,1,1),lwd=2);
layout(matrix(data=c(1,2), nrow=2, ncol=1, byrow = TRUE),
       widths=c(1,1), heights=c(1,1));
# --------------------------------------------------------------------
plot(PI,Alleles_IBD_outbr_pair,type="l",lwd=3,ylim=c(0,1),yaxs="i",xaxs="i",
     xlab=expression(paste("Parental investment (",italic(m),")")),
     ylab=expression(paste("IBD alleles in offspring (",zeta[off],")")),
     cex.lab=1.5,cex.axis=1.5);
abline(h=0,lty="dotted",lwd=0.8);
points(PI,Alleles_IBD_inbr_pair,type="l",lwd=3,lty="dashed");
abline(a=0,b=r00g,lty="solid", lwd=1); # Tangent line r = 0
abline(a=0,b=r05gpB1,lty="dashed",lwd=1); # Tangent line r = 0.5
text(x=0.15,y=0.925,labels="A",cex=2.5);
# --------------------------------------------------------------------
plot(x=bss,y=rg000$mvl,type="l",lwd=2,ylim=c(2,6),pch=1.5,
     xlab=expression(paste("Inbreeding depression (",beta,")")),
     ylab=expression(paste("Optimum PI (",italic(m),"*)")),
     cex.lab=1.5,cex.axis=1.5);
points(x=bss,y=rg125$mvl,type="l",lwd=2);
points(x=bss,y=rg250$mvl,type="l",lwd=2);
points(x=bss,y=rg500$mvl,type="l",lwd=2);
text(x=bss[17],y=rg000$mvl[17]+0.17,labels="r=0",srt=-0,cex=1.15);
text(x=bss[17],y=rg125$mvl[17]+0.17,labels="r=1/8",srt=6,cex=1.15);
text(x=bss[17],y=rg250$mvl[17]+0.17,labels="r=1/4",srt=12.5,cex=1.15);
text(x=bss[17],y=rg500$mvl[17]+0.17,labels="r=1/2",srt=18,cex=1.15);
text(x=0.5,y=5.85,labels="B",cex=2.5);

```

Figure 4 shows optimal PI for two strictly monogamous parents (Fig. 4A) and the corresponding rate of fitness increase (Fig. 4B). Decreasing $\gamma^{*}$ with increasing $r$ is consistent with biparental inbreeding theory, which demonstrates that if inbreeding with a female completely precludes a male from outbreeding, inbreeding will never be beneficial [@Waser1986; @Duthie2015a]. However, if relatives are forced to pair under strict monogamy, each should invest more per offspring than given single parent investment.

```{r, echo=FALSE, fig.width = 4*figscale, fig.height = 8*figscale, fig.cap="Assuming strict monogamy, the relationship between the magnitude of inbreeding depression and the rate of a focal female's fitness increase across four degrees of relatedness between a focal female and her mate given that (A) focal females invest optimally given their degree of inbreeding, (B) females invest at the optimum for outbreeding, and (C) females invest at the optimum for inbreeding first order relatives (r=1/2)."}
#--- Start building the figure below
par(mfrow=c(3,1),mar=c(0.25,5,1,1),lwd=2);
#----------------------------------------------------------------
par(mar=c(1,5,1,1),lwd=2);
plot(x=bss,y=rg000p$gam,type="l",lwd=2,ylim=c(0.05,0.23),pch=1.5,yaxt="n",
     xlab=expression(paste("Inbreeding depression (",beta,")")),xaxt="n",
     ylab="",cex.lab=1.5,cex.axis=1.5);
axis(side=2,at=c(0.05,0.10,0.15,0.20),cex.axis=1.5);
points(x=bss,y=rg125p$gam,type="l",lwd=2);
points(x=bss,y=rg250p$gam,type="l",lwd=2);
points(x=bss,y=rg500p$gam,type="l",lwd=2);
text(x=bss[17],y=rg000p$gam[17]+0.005,labels="r=0",srt=-0,cex=1);
text(x=bss[17],y=rg125p$gam[17]+0.005,labels="r=1/8",srt=-4,cex=1);
text(x=bss[17],y=rg250p$gam[17]+0.005,labels="r=1/4",srt=-6,cex=1);
text(x=bss[17],y=rg500p$gam[17]+0.005,labels="r=1/2",srt=-8,cex=1);
text(x=4.95,y=0.22,labels="A",cex=2.5);
#----------------------------------------------------------------
r000_000pt <- Offpair(r=0.000, m=r00m, mmin=1, Beta=bss, c=1, m0=r00m) / r00m;
r125_000pt <- Offpair(r=0.125, m=r00m, mmin=1, Beta=bss, c=1, m0=r00m) / r00m;
r250_000pt <- Offpair(r=0.250, m=r00m, mmin=1, Beta=bss, c=1, m0=r00m) / r00m;
r500_000pt <- Offpair(r=0.500, m=r00m, mmin=1, Beta=bss, c=1, m0=r00m) / r00m;
par(mar=c(0.5,5,0.25,1),lwd=2);
plot(x=bss,y=r000_000pt,type="l",lwd=2,ylim=c(0.05,0.23),pch=1.5,yaxt="n",
     ylab=expression(paste("Rate of fitness increase (",gamma,"*)")),
     xaxt="n",cex.lab=1.5,cex.axis=1.5);
axis(side=2,at=c(0.05,0.10,0.15,0.20),cex.axis=1.5);
points(x=bss,y=r125_000pt,type="l",lwd=2);
points(x=bss,y=r250_000pt,type="l",lwd=2);
points(x=bss,y=r500_000pt,type="l",lwd=2);
text(x=bss[12],y=r000_000pt[12]+0.005,labels="r=0",srt=-0,cex=1);
text(x=bss[10],y=r125_000pt[10]+0.005,labels="r=1/8",srt=-15,cex=1);
text(x=bss[7],y=r250_000pt[7]+0.005,labels="r=1/4",srt=-34,cex=1);
text(x=bss[4]+0.06,y=r500_000pt[4]+0.004,labels="r=1/2",srt=-55,cex=1);
text(x=4.95,y=0.22,labels="B",cex=2.5);
#----------------------------------------------------------------
r000_000pt <- Offpair(r=0.000, m=r05mpB1, mmin=1, Beta=bss, c=1, m0=r00m) / r05mpB1;
r125_000pt <- Offpair(r=0.125, m=r05mpB1, mmin=1, Beta=bss, c=1, m0=r00m) / r05mpB1;
r250_000pt <- Offpair(r=0.250, m=r05mpB1, mmin=1, Beta=bss, c=1, m0=r00m) / r05mpB1;
r500_000pt <- Offpair(r=0.500, m=r05mpB1, mmin=1, Beta=bss, c=1, m0=r00m) / r05mpB1;
par(mar=c(5,5,0.25,1),lwd=2);
plot(x=bss,y=rg000fs$gam,type="l",lwd=2,ylim=c(0.05,0.23),pch=1.5,yaxt="n",
     xlab=expression(paste("Inbreeding depression (",beta,")")),
     ylab="",cex.lab=1.5,cex.axis=1.5);
axis(side=2,at=c(0.05,0.10,0.15,0.20),cex.axis=1.5);
points(x=bss,y=rg125fs$gam,type="l",lwd=2);
points(x=bss,y=rg250fs$gam,type="l",lwd=2);
points(x=bss,y=rg500fs$gam,type="l",lwd=2);
text(x=bss[2],y=rg000fs$gam[2]+0.006,labels="r=0",srt=-15,cex=1);
text(x=bss[2],y=rg125fs$gam[2]+0.006,labels="r=1/8",srt=-18,cex=1);
text(x=bss[2],y=rg250fs$gam[2]+0.006,labels="r=1/4",srt=-20,cex=1);
text(x=bss[2],y=rg500fs$gam[2]+0.006,labels="r=1/2",srt=-33,cex=1);
text(x=4.95,y=0.22,labels="C",cex=2.5);
#----------------------------------------------------------------
```


Investment and fitness of an inbred parent
------------------------------------------------

We have assumed that parents are themselves outbred, but this is unrealistic for populations in which inbreeding is expected to occur [@Duthie2015a]. We therefore consider how the degree to which a focal female is inbred will affect her optimum parental care ($m^{*}$) and rate of increase in fitness ($\gamma^{*}$).

If a focal female is inbred, then the degree to which she is inbred should affect her transmission of identical-by-descent alleles $\left(1/2\right)\left(1+r\right)$, but not inbreeding depression in her offspring $\left(1 - \exp\left[-c\left(m-m_{min}-\beta r\right)\right]\right)$. To account for an inbred parent, it is most useful to decompose the coefficient of relatedness $r$ into two parts [see @Hamilton1972; @Michod1979]. The first is the constituent coefficient of kinship $k$, which is the probability that a two randomly sampled homologous alleles between the focal female and her mate are identical-by-descent. The second is the focal female's own inbreeding coefficient $f$, which is the probability that two homologous alleles within the focal female herself are identical-by-descent. The coefficient $r$ can be defined as such,

(@rdef) $$ r = \frac{2k}{1 + f} $$

Relatedness between two individuals is increased by an increase in $k$. Because $k$ is defined by the probability that homologous identical-by-descent alleles are paired between mates, and inbreeding depression is widely assumed to be caused by the pairing of deleterious recessive alleles [@Charlesworth2009], the value of $k$ is relevant for modelling inbreeding depression (and in fact defines an offspring's $f$). In contrast, relatedness between a focal female and a relative decreases with increasing $f$, but $f$ does not directly affect the degree to which homologous deleterious recessive alleles from two different parents will pair in inbred offspring, and therefore does not contribute to inbreeding depression. To understand how $\zeta_{\textrm{off}}$ is affected by $f$ and $k$, and thereby relax the assumption that a focal female is outbred, it is therefore useful to clarify,

(@maineqr) $$\zeta_{\textrm{off}} = \frac{1}{2}\left(1+\frac{2k}{1+f}\right)\left(1-e^{-c\left(m-m_{min}-2\beta k\right)}\right).$$

<!--- One potentially important point: The first expression here is not the same as the expected allele copies in offspring, as in Jane's manuscript. The reason is that Jane was looking at the total identical-by-descent allele copies an offspring has of its parent's. This made sense in the context of the Evolution manuscript, but here we really should be interested in the rate at which IBD alleles are produced in offspring per IBD allele in the parent. This means that we should divide by (1 + f) instead of adding f. The rate of increase is what seleciton should act on. --->

Note that if $f=0$ (the focal female is outbred), then Eq. @maineqr reduces to Eq. @maineq because $r=2k$. Because the $f$ of a focal parent does not affect inbreeding depression in its offspring, and instead only affects the fitness increment (the first expression $1/2\left[1+r\right]$ previously described), $m^{*}$ is unaffected (see also Appendix 2). The degree to which a female is herself inbred should therefore not affect her PI in offspring.

```{r, echo=FALSE}
OffATf <- function(f, k, m, B0=1, B1=1, c=1){
    return( (1/2)*(1+(2*k/(1+f))) * (1 - exp(-c*(m - B0 - 2*B1*k)) ));
}
findmf <- function(low.guess,high.guess,kval,fval,B1=1,c=1,B0=1){
  OffATf <- function(m, f=fval, k=kval, B0=1, B1=1, c=1){
    return( (1/2)*(1+(2*k/(1+f))) * (1 - exp(-c*(m - B0 - 2*B1*k)) ));
  }
  OffATff <- function(m, k=kval, f=fval, B0=1, B1=1, c=1){
    return( 0.5 * (1 + (2 * k/(f + 1))) * (exp(-c * (m - B0 - 2 * B1 * k)) * c) );
  }    
  fm <- function(m, f=fval, k=kval, B0=1, B1=1, c=1){
    OffATff(m=m, f=fval, k=kval, B0=B0, B1=B1, c=c)*(0-m) + 
          OffATf(m=m, f=fval, k=kval, B0=B0, B1=B1, c=c);
  }
  lg  <- fm(m=low.guess, k=kval, f=fval);
  hg  <- fm(m=high.guess,k=kval, f=fval);
  if(lg > 0){
    u <- low.guess;
    l <- high.guess;
  }else{
    u <- high.guess;
    l <- low.guess;
  }
  if((fm(l) > 0 & fm(u) > 0) | (fm(l) < 0 & fm(u) < 0)){
    return("Value of m is outside the range");
  }else{
    check  <- 1;
    mguess <- 0.5 * (l+u);
    i      <- 0;
    while(abs(check) > 0.001 & i < 10000){
        check <- fm(k=kval, f=fval, m=mguess);
        if(check > 0){
          u      <- mguess;
          mguess <- 0.5*(l+mguess); 
        }else{
          l      <- mguess;
          mguess <- 0.5*(u+mguess);
        }
        i <- i+1;
    }
    return(mguess);
  }
} # Running the below returns the estimate
imopt.f000 <- findmf(low.guess=0,high.guess=4,kval=0.25,fval=0.0, B1=1);
imopt.f025 <- findmf(low.guess=0,high.guess=4,kval=0.25,fval=0.25, B1=1);
itang.f000 <- OffATf(m=imopt.f000, f=0, k=0.25, B0=1, B1=1, c=1) / imopt.f000;
itang.f025 <- OffATf(m=imopt.f025, f=0.25, k=0.25, B0=1, B1=1, c=1) / imopt.f025;
omopt.f000 <- findmf(low.guess=0,high.guess=4,kval=0.0,fval=0.0, B1=1);
omopt.f025 <- findmf(low.guess=0,high.guess=4,kval=0.0,fval=0.25, B1=1);
otang.f000 <- OffATf(m=omopt.f000, f=0, k=0.0, B0=1, B1=1, c=1) / omopt.f000;
otang.f025 <- OffATf(m=omopt.f025, f=0.25, k=0.0, B0=1, B1=1, c=1) / omopt.f025;
```

Further, the degree to which a female is inbred should only slightly affect $\gamma^{*}$, and only if $k>0$. If $k=0$, then $\gamma^{*}$ is unaffected because there is no inbreeding depression, so $\gamma^{*}=$ `r round(otang.f025,digits=3)` for all values of $f$ given the previously considered $\beta=1$, $m_{min}=1$, and $c=1$. If instead $k=1/4$ (inbreeding between first order relatives) and $f=1/4$ (the female is the offspring of first order relatives), then a slight decrease in $\gamma^{*}$ is predicted. If $k=1/4$ and $f=1/4$, then $\gamma^{*}=$ `r round(itang.f025,digits=3)`, versus $\gamma^{*}=$ `r round(itang.f000,digits=3)` given $f=0$. The difference between these two curves predicting $\zeta_{\textrm{off}}(m)$ for $f=0$ and $f=1/4$ given $k=1/4$ is shown in Fig. 5.

```{r, echo=FALSE, fig.cap="Relationship between parental investment and the proportion of a focal female's identical-by-descent alleles that are are carried in its offspring for females that are outbred (upper curve) versus females that are inbred (lower curve). Grey shading between curves shows the fitness difference between outbred and inbred females across different degrees of parental invesment."}
Alleles_IBD_f000 <- OffATf(k=0.25, f=0.0, m=PI, B0=1, B1=1, c=1);
par(mar=c(5,5,2,2));
plot(PI,Alleles_IBD_f000,type="l",lwd=1,ylim=c(0,0.95),lty="solid",
     xlab=expression(paste("Parental investment (",italic(m),")")),
     ylab=expression(paste("IBD alleles in offspring (",zeta[off],")")),
     cex.lab=1.5,cex.axis=1.5,yaxs="i",xaxs="i");
abline(h=0,lty="dotted",lwd=0.8);
Alleles_IBD_f025 <- OffATf(k=0.25, f=0.25, m=PI, B0=1, B1=1, c=1);
abline(b=itang.f000,a=0,lty="solid",lwd=0.5,col="grey40");
abline(b=itang.f025,a=0,lty="solid",lwd=0.5,col="grey40");
polygon(x=c(PI,rev(PI)),y=c(Alleles_IBD_f000,rev(Alleles_IBD_f025)),col="grey70",border=NA);
points(PI,Alleles_IBD_f025,type="l",lwd=1,col="black",lty="solid");
points(PI,Alleles_IBD_f000,type="l",lwd=1,col="black",lty="solid");
yof000 <- OffATf(k=0.25, f=0.0,  m=imopt.f000, B0=1, B1=1, c=1);
yof025 <- OffATf(k=0.25, f=0.25, m=imopt.f025, B0=1, B1=1, c=1);
xline  <- seq(from=1,to=imopt.f000,by=0.001);
points(x=xline,y=rep(yof000,length(xline)),type="l",lwd=1);
points(x=xline,y=rep(yof025,length(xline)),type="l",lwd=1);
yline  <- seq(from=0,to=yof025,by=0.001);
points(x=rep(imopt.f025,length(yline)),y=yline,type="l",lwd=1);
text(x=3.5,y=0.255,labels=expression(paste(italic(m^{"*"}))),cex=1.75);
arrows(x0=3.345,y0=0.205,x1=imopt.f025+0.04,y1=0.01,length = 0.15,angle=30,code=2,lwd=2);
text(x=0.75,y=0.8,labels=expression(paste(italic(f==0))),cex=1.25);
arrows(x0=0.8,y0=0.75,x1=1.1,y1=yof000+0.01,length = 0.15,angle=30,code=2,lwd=2);
text(x=0.67,y=0.35,labels=expression(paste(italic(f==frac(1,4)))),cex=1.25);
arrows(x0=0.87,y0=0.36,x1=1.1,y1=yof025-0.01,length = 0.15,angle=30,code=2,lwd=2);
```

The bottom curve of Fig. 5 shows $\zeta_{\textrm{off}}(m)$ given $f=1/4$, and the top curve shows $\zeta_{\textrm{off}}(m)$ given $f=0$, with the difference between $\zeta_{\textrm{off}}(m)$ represented by grey shading. Where $m=m^{*}$, $\zeta_{\textrm{off}}$ is slightly higher for $f=0$, meaning that the rate of fitness increase (here, technically, identical-by-descent alleles carried by offspring scaled by their frequency within the parent) is higher for outbred individuals even though optimal investment per offspring has not changed ($m^{*}_{f=0}=m^{*}_{f=1/4}$). Thin grey lines in the figure show tangent lines for each curve. Overall, Fig 5 shows a weak effect on $\gamma^{*}$ across a relatively wide range of $f$ (outbred individuals versus individuals of full sibling matings). Consequently, the degree to which an individual is inbred will have a relatively minor effect on its rate of fitness increase, but no effect on the optimal PI it provides to offspring.

******************************

Discussion
===================================================

We have provided a framework for synthesising biparental inbreeding theory and parental investment theory. Our results show that biparental inbreeding can alter optimal PI, thereby affecting parent and offspring fitness. Specifically, we have shown that when offspring are inbred, the optimal PI provided by a single female should always increase, and this increase in optimal PI should be greatest when inbreeding depression is high. We have also shown that, in contrast to outbreeding [@Parker1985], optimal PI changes when both parents invest given strict monogamy as opposed to single PI; under such conditions, optimal PI increases, but the fitness of inbreeding parents never exceeds that of outbreeding parents. Finally, we have shown that optimal PI does not change when a focal female is herself inbred, but her fitness, defined in as the rate at which she increases copies of her identical-by-descent alleles, is decreased. Our modelling has potentially widespread empirical implications, and extensions of our model can further inform theory on the interaction between inbreeding and parental investment.

Multiple studies estimate magnitudes of inbreeding depression in offspring fitness [@Charlesworth2009; @Szulkin2012], but predicting how the effects of inbreeding depression in offspring in turn affect parent fitness and subsequent evolution of behaviour remains empirically challenging [@Reid2015b]. Further, because PI might encompass a range of behaviours, each of which is an instance of allocation from an unknown total PI budget, PI is notoriously difficult to measure [@Parker2002]. One approach is to vary PI experimentally by excluding a parent during offspring development. @Pilakouta2015 quantified the fitness of burying beetle (*Nicrophorus vespilloides*) offspring in the presence and absence of maternal care, and for inbred and outbred offspring, finding that maternal care increased survival relatively more for inbred than outbred offspring. Their result is consistent with our assumption that PI can mitigate inbreeding depression and thereby buffer offspring fitness.  Similarly, in the subsocial spider *Anelosimus* cf. *jucundus*, in which care is provided by solitary females, @Aviles2006 found evidence of inbreeding depression only late in life when parental care was absent. They also hypothesise that maternal care might buffer inbreeding depression. Interestingly, clutch size does not decrease when *A.* cf. *jucundus* females inbreed as our model predicts, and as would be expected if females respond to inbreeding by increasing PI per offspring at the cost of total offspring production. In the European earwig (*Forficula auricularia*), @Meunier2013 also found no evidence that clutch size decreased with inbreeding, nor that parental care buffers inbreeding depression. It is possible that the ability of parents to adjust PI based on inbreeding might be precluded in such systems if kin recognition is limited, potentially resulting in severe fitness costs if parents cannot determine their degree of inbreeding (Fig. 3). Empirical tests of our model might therefore be most applicable to species that are known to vary their behaviour with respect to relatedness.

Adjustment of PI with inbreeding is most likely to occur in social species, where interactions among relatives strongly affect fitness, and for species in which realised inbreeding typically varies and inbreeding strategies are therefore potentially under selection. For example, wolves are highly social (and generally monogamous), and individuals may inbreed to varying degrees with potentially severe inbreeding depression [@Raikkonen2009; @Geffen2011]. To our knowledge, no empirical studies have tested whether or not PI varies with inbreeding in wolves, but two studies found a negative correlation between parent inbreeding and the number of pups per litter [e.g, @Liberg2005; @Fredrickson2007]. In both studies, decreased reproductive output is interpreted as a negative fitness consequence of inbreeding, as might be expected if inbreeding depression causes increased early offspring mortality. Our model suggests an alternative hypothesis; fewer pups per litter might be partially driven by an adaptive strategy whereby parents invest more in fewer total offspring. Distinguishing between inbreeding depression and adjusted PI will require careful observation of variation in PI in wild populations, but our model demonstrates that reduced reproductive output cannot necessarily be assumed to be a negative fitness consequence of inbreeding.

Similarly, if reproductive output does not vary, or varies weakly, with inbreeding, this cannot necessarily be assumed to reflect uniform parent fitness. Recently, Reid et al. (*in revision*) showed that parent-offspring relatedness varies in a wild population of song sparrows (*Melospiza melodia*) as a consequence of inbreeding, and suggest that parent fitness is more accurately reflected by identical-by-descent allele copies expected within offspring rather than raw offspring production. A female that produces an outbred brood might therefore have lower fitness than a female that produces an inbred brood of the same (or slightly smaller) size, assuming the fitness of inbred offspring is not sufficiently decreased. Interestingly, if brood size is externally fixed, females that have large total resource budgets ($M$ in our model) might benefit by inbreeding if they are able to allocate more PI to each of their offspring. To quantify parent fitness and predict inbreeding strategy, it might therefore be necessary to consider inbreeding and reproductive output in the context of PI.

Interactions over PI are characterised by intrafamilial conflict between parents, parents and offspring, and among siblings [@Parker2002]. We have largely ignored such conflict to instead establish a theoretical framework for understanding PI in the context of inbreeding. We assumed that only females provide PI, or that the fitness interests of females and males are perfectly aligned due to strict monogamy, so that no sexual conflict occurs. If both parents invest and are not completely monogamous, sexual conflict is predicted because each parent will increase its fitness if it invests less in a brood than its mate (e.g., by abandoning the brood early and leaving its mate to invest alone). Optimal PI can then be modelled as an evolutionary stable strategy [@Smith1977], and is expected to decrease for both parents as a consequence of sexual conflict [@Parker1985]. To account for inbreeding across mating systems, it is necessary to consider indirect effects of inclusive fitness caused by the reproduction of relatives, as we did in considering male mating opportunity costs. Indirect effects might minimise sexual conflict when PI is provided by both parents in non-monogamous species because any negative fitness consequence of reducing PI could be exacerbated through an indirect effect on a focal individual's related mate. 
<!--- XXX SOMETHING IS WRONG IN THE PARAGRPAH BELOW? Fixed? --->
Sexual conflict might also be minimised if a focal individual that decreases its PI must wait for another mate to become available. @Kokko2006 considered the fitness consequences of inbreeding and inbreeding avoidance under such conditions, modelling a processing time after mating (interpreted as PI) and finding that inbreeding tolerance generally increased with increasing waiting time between mates, but was highly context-dependent with respect to processing time. However, processing time was a fixed parameter in @Kokko2006, meaning that individuals could not effectively adjust PI as a consequence of inbreeding (as in our model) -- only their inbreeding as a consequence of pre-determined PI. It would be interesting to relax this assumption and allow for inbreeding depression to vary as a consequence of processing time under the framework of @Kokko2006. If PI could vary, individuals that inbreed might be expected to increase their time spent processing offspring before attempting to mate again.

Parent-offspring conflict is a focal theoretical interest of many models of PI [e.g., @Macnair1978; @Parker1978; @Parker1985; @DeJong2005]. We have assumed that parents control PI, and that offspring are unable to influence the extent to which PI is provided (e.g., through begging). Offspring are predicted to benefit at higher PI than parent optima [@Parker1978; @Parker2002], therefore generating conflict, but such conflict might be decreased in the case of inbreeding. Inbreeding parents are more closely related to their offspring than outbreeding parents, generating the increase in parents' optimal PI in our model; in the extreme case in which $r=1$ (self-fertilisation), no conflict over PI should exist. @DeJong2005 model PI conflict in the context of optimal seed mass from the perspective of parent plants and their seeds given varying rates of self-fertilisation, showing that conflict over seed mass decreases with increasing self-fertilisation rate. @DeJong2005 assume seed mass is under the control of seeds rather than parent plants, and find that a comparative analysis of seed size among closely related plant species generally supports this hypothesis. In general, the same principles of parent-offspring conflict are expected to apply for biparental inbreeding as in self-fertilisation. Parent-offspring conflict should decrease with increasing inbreeding, and reduced conflict might in turn affect offspring behaviour. For example, @Mattey2014 observed both increased parental care and decreased offspring begging in an experimental study of *N. vispilloides*. A reduction in begging behaviour is consistent with our model when inbreeding increases and parent-offspring fitness interests with respect to PI are more closely aligned.

<!--- [Is it worth opening up this can of worms?] We have assumed that the offspring of a focal parent are not inbred to different degrees. While this was a useful simplifying assumption, parents of many species will vary their degree inbreeding both within a single brood and over the course of a lifetime [@Reid2016]. --->

<!--- We assume that there are no mixed broods -- will need to figure out what happens when some offspring are inbred but others are not. --->

We conclude that optimal PI is predicted to increase when parents inbreed, potentially buffering inbreeding depression, decreasing parent's reproductive output, and mitigating intrafamilial conflict. We suggest that future empirical and theoretical research will benefit by further considering how biparental inbreeding and PI are expected to interact to affect parent and offspring fitness. 

<!--- We encourage that empirical and theoretical research take PI into account --->


<!---
Theory should look at non-uniparental investment and non-strict monogamy. This will get complicated because it will have to incorporate opportunity costs for males with respect to inbreeding, but also evolutionary stable strategies surrounding investment @Parker1985 showed that care is reduced by ESS given outbreeding, and the issue is likely to be complicated more by inbreeding due to the changing parent-offspring relatedness and indirect effects of investment by relatives -- will probably be a shorter paragraph. -- Related parents might reduce conflict, thereby having a positive effect on PI provided.  -> Kokko2006 consider parental care, but not the idea that parents can change their PI following outbred versus inbred mating.
--->

<!---
We have assumed that parents control investment with no parent-offspring conflict, but offspring might have more say in their own investment. @DeJong2005 assumed that seed size is under offspring control, and found that the empirical evidence is largely in support of this. 
--->

**************************


<!---
Pivot now in the third paragraph and talk about how lower clutch size might be caused by an adaptive response shifting focus to the production of fewer offspring. Maybe a brief mention that this might have conservation concerns. Also, next note (same paragraph, I think) that if individuals have a fixed amount of offspring that they are expected to produce, if they have an unusually high amount of PI to invest, then they might just be better off inbreeding and increasing the fitness of those offspring. Studies might therefore need to take the adaptive strategy of individuals into account and control for PI when measuring inbreeding depression.


Wolves can probably recognise relatedness and stuff -- lead into that as a system and mention the brood size papers. Try to wrap up the empirical stuff with some discussion about what the look at next. Could lead into non-uniparental investment $\to$ back to talk about theory.

--->

<!---
* There are some serious empirical implications of our results, and previous scientists have suggested that parental investment might buffer inbreeding depression -- here we show that this verbal idea works. It also means, however, that females might want to invest more in fewer offspring, so we should be aware of the effects of inbreeding on offspring production, and not assume that this is due to inbreeding (as some scientists imply).
--->


<!--- (1) to show how optimal PI changes when offpsring are inbred, and for different magnitudes of inbreeding depression; (2) to show how an inbreeding female's optimal PI is indirectly affected by opportunity costs when both parents invest in offspring; and (3) to show how parental fitness, but not optimal PI, is decreased when an inbreeding female is herself inbred. --->

<!---
Key points to hit in the Discussion:

* Reiterate that there is no theory addressing how parental investment should affect inbreeding depression [@Pilakouta2015]. 
* If a female inbreeds by choice or necessity, she should make fewer offspring and increase her parental investment in each one.
* Lower offspring production for inbreeding versus outbreeding females does not necessarily reflect consequences of inbreeding depression [e.g, @Liberg2005; @Fredrickson2007].
* If offspring number is fixed, the best strategy might be to inbreed.
* Parent-offspring conflict will be reduced by inbreeding.
* Comparison with selfing literature for optimal seed size.

Empirical studies suggest that parental investment increases offspring fitness relatively more when offspring are inbred [@Aviles2006; @Pilakouta2015]
--->



Appendix 1: Sample derivations of $m^{*}$ and $\gamma^{*}$
----------------------------------------------

In general, the equation for a line tangent to some function $f$ at the point $a$ is,

$$ y = f'\left(a\right)\left(x-a\right) + f\left(a\right). $$

In the above, $f'(a)$ is the first derivative of $f(a)$, and $y$ and $x$ define the point of interest through which the straight line will pass that is also tangent to $f(a)$. The original function that defines $\zeta_{\textrm{off}}$ is as follows,

$$\zeta_{\textrm{off}} = \frac{1}{2}\left(1+r\right)\left(1-e^{-c\left(m-m_{min}-\beta r\right)}\right).$$

Differentiating $\zeta_{\textrm{off}}$ with respect to $m$, we have the following,

```{r, echo=FALSE}
fm <- expression(0.5*(1+r)*(1-exp(-c*(m-B0-B1*r))),'m');
fm1 <- D(fm,'m');
```

$$\frac{\partial \zeta_{\textrm{off}}}{\partial m} = \frac{c}{2} \left(1+r\right)e^{-c\left(m-m_{min}-\beta r\right)}. $$

Substituting $\zeta_{\textrm{off}}(m)$ and $\partial \zeta_{\textrm{off}} / \partial m$ and setting $y=0$ and $x=0$ (origin), we have the general equation, 

$$ 0 = \frac{c}{2} \left(1+r\right)e^{-c\left(m-m_{min}-\beta r\right)}\left(0-m\right) + \frac{1}{2}\left(1+r\right)\left(1-e^{-c\left(m-m_{min}-\beta r\right)}\right). $$

```{r, echo=FALSE}
r00m.y <- OffATr(r=0,  m=r00m, mmin=1, Beta=1, c=1);
r05m.y <- OffATr(r=0.5, m=r05m, mmin=1, Beta=1, c=1);
```

A solution for $m^{*}$ can be obtained numerically for the example in which $m_{min}=1$, $\beta=1$, and $c=1$. If $r=0$, $m^{*}_{r=0}=$ `r round(r00m,digits=3)`, and if $r=1/2$, $m^{*}_{r=1/2}=$ `r round(r05m,digits=3)`. Solutions for the slopes defining $\gamma^{*}_{r=0}$ and $\gamma^{*}_{r=1/2}$ can be obtained by finding the straight line that runs through the two points $(0,0)$ and $(m^{*}$ , $\zeta_{\textrm{off}}(m^{*}))$. In the case of $r=0$, $\zeta_{\textrm{off}}(m^{*})=$ `r round(r00m.y,digits=3)`, so we find, $\gamma^{*}_{r=0}=$ (`r round(r00m.y,digits=3)` $- 0$) $/$ (`r round(r00m,digits=3)` $- 0$) = `r round(r00g,digits=3)`. In the case of $r=1/2$, $\zeta_{\textrm{off}}(m^{*})=$ `r round(r05m.y,digits=3)`, so we find, $\gamma^{*}_{r=1/2}=$ (`r round(r05m.y,digits=3)` $- 0$) $/$ (`r round(r05m,digits=3)` $- 0$) = `r round(r05g,digits=3)`. 

Appendix 2: $m^{*}$ increases with increasing $r$
----------------------------------------------

Here we show that optimal parental investment always increases with increasing inbreeding given inbreeding depression and $c>0$. Because we are only interested in the sign of this increase, it will be sufficient to show that $\partial r / \partial m^{*} > 0$ given $\beta>0$ and $c>0$. 

First, we note that $m^{*}$ is defined as the value of $m$ that maximises the rate of increase in $\zeta_{\textrm{off}}$ for a female. This is described by the line that passes through the origin and lies tangent to $\zeta_{\textrm{off}}(m)$. As in Appendix 1, we have the general equation for which $m=m^{*}$,

$$ 0 = \frac{c}{2} \left(1+r\right)e^{-c\left(m-m_{min}-\beta r\right)}\left(0-m\right) + \frac{1}{2}\left(1+r\right)\left(1-e^{-c\left(m-m_{min}-\beta r\right)}\right). $$

We first substitute $m=m^{*}$ and note that this equation reduces to,

$$ 0 = c e^{-c\left(m^{*}-m_{min}-\beta r\right)}\left(0-m^{*}\right) + \left(1-e^{-c\left(m^{*}-m_{min}-\beta r\right)}\right). $$

This simplification dividing both sides of the equation by $(1/2)(1+r)$ has a biological interpretaion that is relevant to parental investment. Optimal parental investment does not depend directly on the uniform increase in $\zeta_{\textrm{off}}$ caused by $r$ in $(1/2)(1+r)$, the change in $m^{*}$ is only affected by $r$ insofar as $r$ affects offspring fitness directly through inbreeding depression. Ideally, we would isolate $m$ to find $\partial m^{*} / \partial r$, but this is not possible. Instead, the above equation can be simplified further to isolate $r$ and show that $\partial r / \partial m^{*} > 0$,

$$ 0 = -m^{*} c e^{-c\left(m^{*}-m_{min}-\beta r\right)} + 1-e^{-c\left(m^{*}-m_{min}-\beta r\right)}. $$

$$ 1 = m^{*} c e^{-c\left(m^{*}-m_{min}-\beta r\right)} + e^{-c\left(m^{*}-m_{min}-\beta r\right)}. $$

$$ 1 = e^{-c\left(m^{*}-m_{min}-\beta r\right)} \left(1 + m^{*} c\right) $$

$$ e^{-c\left(m^{*}-m_{min}-\beta r\right)} = \frac{1}{\left(1 + m^{*} c\right)} $$

$$ -c\left(m^{*}-m_{min}-\beta r\right) = \ln\left(\frac{1}{\left(1 + m^{*} c\right)}\right) $$

$$ m^{*}-m_{min}-\beta r = -\frac{1}{c}\ln\left(\frac{1}{\left(1 + m^{*} c\right)}\right) $$

$$ \beta r = m^{*} - m_{min} + \frac{1}{c}\ln\left(\frac{1}{\left(1 + m^{*} c\right)}\right) $$

$$ r = \frac{1}{\beta}\left(m^{*} - m_{min} + \frac{1}{c}\ln\left(\frac{1}{\left(1 + m^{*} c\right)}\right)\right) $$

We now differentiate $r$ with respect to $m^{*}$,

```{r, echo=FALSE}
rrmm  <- expression((1/beta)*(mopt-mmin+(1/c)*log(1/(mopt*c+1))),'mopt');
# We can use the above to differentiate fm wrt `m`
drdm <- D(rrmm,'mopt'); # can print fmd to show solution
# Note that drdm simplifies considerably from what R produces
```

$$ \frac{\partial r}{\partial m^{*}} = \frac{m^{*} c}{\beta \left(m^{*} c + 1\right)} $$

Given the above, $\partial r / \partial m^{*} > 0$ assuming $\beta>0$ (inbreeding depression), $c>0$ (offspring fitness increases with parental investment), and $m^{*}>0$ (optimum parental investment is positive). These assumptions are biologically realistic; we therefore conclude that the positive association between optimal parental investment ($m^{*}$) and inbreeding ($r$) is general. As inbreeding increases, so should optimal parental investment in offspring.

Appendix 3: Consistency with biparental inbreeding models
----------------------------------------------

It is trivial to show that a female that inbreeds with a first order relative ($r=1/2$) has a higher fitness than a female that outbreeds ($r=0$) given $m_{min}=1$, $\beta=1$, and $c=1$ at optimal values of $m^{*}_{r=1/2}$ and $m^{*}_{r=0}$. To do this, we define $\delta_{r}$ as follows,

$$ \delta_{r} = e^{-c(m^{*}_{r}-m_{min}-\beta r)}. $$

In biparental inbreeding models [e.g., @Kokko2006; @Parker2006; @Duthie2015a], it is assumed that $\delta_{r=0}=0$ for outbred offspring, but this is not the case in our model because $\delta_{r=0}$ will also depend on parental investment. Fitness from inbreeding to any degree $r$ can be determined by,

$$ W_{r} = \frac{n}{2}\left(1+r\right)\left(1-\delta_{r}\right). $$

By definition, $n = M/m$, so $n$ is the total number of offspring a female produces. Biparental inbreeding models assume that this value is constant, but $n$ will scale linearly with $m$ because females that invest more in each offspring (high $m$) will produce fewer total offspring (low $n$). To account for this, we can simply substitute $M/m$ for $n$ to scale for offspring produced,

$$ W_{r} = \frac{M}{2 m}\left(1+r\right)\left(1-\delta_{r}\right). $$

Fitness given $r=0$ and $r=1/2$, and $m^{*}_{r=0}$ and $m^{*}_{r=1/2}$, can be determined by substituting some constant value for $M$ (here for simplicity, assume $M=1$), as the magnitude of $n$ will not affect relative fitness differences. 

To show that inbreeding with first order relatives returns a higher fitness than outbreeding given the above conditions assumed in our model, we can simply use the above equation directly to compare the fitness given both $r=1/2$ and $r=0$, noting that $\delta_{r=1/2}=0.26$ and $\delta_{r=0}=0.32$ (note that $\delta_{r=1/2}<\delta_{r=0}$ because inbreeding parents are investing more in their offspring, $m^{*}_{r=1/2}=$ `r round(r05m,digits=3)` versus $m^{*}_{r=0}=$ `r round(r00m,digits=3)`). Consequently, we can use the above equation to show that the fitness gain of an optimally investing female that inbreeds with a first order relative is `r round((1/(r05m*2))*(1+0.5)*(1-exp(-1*(r05m - 1 -1*0.5))),digits=3)`, compared with `r round((1/(r00m*2))*(1+0.0)*(1-exp(-1*(r00m - 1 -1*0.0))),digits=3)` for the outbreeding female; these values are identical to our earlier calculated values of $\gamma^{*}_{r=1/2}$ and $\gamma^{*}_{r=0}$.

<!--- Note that we can expand this -- n * (\zeta_{\textrm{off}} / m) --->
<!---
Thoughts in progress
----------------------------------------------

Note that we can formulate the optimal contribution for an individual parent $m_{p}^{*}$ as the value of m that satisfies the following [see @Parker1985],

$$m = \frac{2 \zeta_{\textrm{off}}(m)}{\partial \zeta_{\textrm{off}}(m) / \partial m}$$

--->

******************************

Supporting information
----------------------------------------------

Suppose we assume that some amount of reduction in offspring fitness due to inbreeding cannot be mitigated by parental investment, $(1 - \Delta r)$, such that offspring fitness decreases linearly with increasing $\Delta$ and $r$ regardless of $m$. In this case, $\zeta_{\textrm{off}}$ is simply,

$$\zeta_{\textrm{off}} = \frac{1}{2}\left(1+r\right)\left(1-e^{-c\left(m-m_{min}-\beta r\right)}\right) \left(1 - \Delta r\right).$$

Note that offspring fitness now decreases with $\Delta$, but $\Delta$ (by definition) is independent of $m$. A simple example illustrates how $\zeta_{\textrm{off}}$ and therefore $\gamma^{*}$ decreases with increasing $\Delta$, while $m^{*}$ remains unaffected. We return to the example in which $c=1$, $m_{min}=1$, $\beta=1$, and $r=1/2$ (inbreeding between first order relatives).

```{r, echo=FALSE}
fm  <- expression(0.5*(1+r) * (1 - exp(-c*(m-mmin-Beta*r))) * (1-r*Delta),'m');
# We can use the above to differentiate fm wrt `m`
fmd <- D(fm,'m'); # can print fmd to show solution
OffDelta <- function(r, m, mmin=1, Beta=1, c=1, Delta){
    return( 0.5*(1+r) * (1 - exp(-c*(m-mmin-Beta*r))) * (1-r*Delta) );
}
OffDeltad <- function(r, m, mmin=1, Beta=1, c=1, Delta){
    return( 0.5 * (1 + r) * (exp(-c * (m - mmin - Beta * r)) * c)*(1-r*Delta) );
}
findmDelta <- function(low.guess,high.guess,rval,mmin=1,Beta=1,c=1,Delta){
    fm  <- function(m,r=rval, DD=Delta){ 
        OffDeltad(r=rval, mmin=mmin, Beta=Beta, m=m, c=c, Delta=Delta)*(0-m) + 
            OffDelta(r=rval, mmin=mmin, Beta=Beta, m=m, c=c, Delta=Delta);
    }
    lg  <- fm(m=low.guess, r=rval, DD=Delta);
    hg  <- fm(m=high.guess,r=rval, DD=Delta);
    if(lg > 0){
        u <- low.guess;
        l <- high.guess;
    }else{
        u <- high.guess;
        l <- low.guess;
    }
    if((fm(l) > 0 & fm(u) > 0) | (fm(l) < 0 & fm(u) < 0)){
        return("Value of m is outside the range");
    }else{
        check  <- 1;
        mguess <- 0.5 * (l+u);
        i      <- 0;
        while(abs(check) > 0.000001 & i < 1000000){
            check <- fm(r=rval, m=mguess);
            if(check > 0){
                u      <- mguess;
                mguess <- 0.5*(l+mguess); 
            }else{
                l      <- mguess;
                mguess <- 0.5*(u+mguess);
            }
            i <- i+1;
        }
        return(mguess);
    }
} # Running the below returns the estimate
Beta <- 1;
c    <- 1;
mmin <- 1;
rva  <- 0.5;
Delt <- 0; # First show no Delta
Del1 <- OffDelta(m=PI,r=0.5,Delta=Delt, Beta=1);
par(mar=c(5,5,1,1));
plot(x=PI,y=Del1,type="l",lwd=2,ylim=c(0,1),
     xlab=expression(paste("Parental investment (",italic(m),")")),
     ylab=expression(paste("IBD alleles in offspring (",zeta[off],")")),
     cex.lab=1.5,cex.axis=1.5,yaxs="i",xaxs="i");
d1m <- findmDelta(low.guess=0,high.guess=10,rval=0.5,Delta=Delt);
d1g <- OffDelta(r=rva, mmin=mmin, Beta=Beta, m=d1m, c=c, Delta=Delt) / d1m;
abline(a=0,b=d1g,col="black");
Delt <- 0.5; # Now show significant delta
Del2 <- OffDelta(m=PI,r=0.5,Delta=Delt, Beta=1);
points(x=PI,y=Del2,type="l",lwd=2,ylim=c(0,1),lty="dashed");
d2m <- findmDelta(low.guess=0,high.guess=10,rval=0.5,Delta=Delt);
d2g <- OffDelta(r=rva, mmin=mmin, Beta=Beta, m=d2m, c=c, Delta=Delt) / d2m;
abline(a=0,b=d2g,lty="dashed");

```

The figure above compares $\Delta=0$ (solid curve) with $\Delta=1/2$ (dashed curve). When strong inbreeding depression exists with an effect that is independent of $m$, optimal parental investment does not change, and $m^{*}=$ `r round(d2m,digits=3)`. Yet while $m^{*}$ is unaffected by $\Delta$, an additional source of inbreeding depression has a predictable negative effect on $\zeta_{\textrm{off}}$, with a rate of fitness increase $\gamma^{*}$ of `r round(d1g,digits=3)` (solid line) when $\Delta=0$ and `r round(d2g,digits=3)` when $\Delta=1/2$ (dashed line). The inclusion of $\Delta$ effectively relaxes the assumption that sufficient parental investment can always compensate for being inbred. For inbred offspring, $\zeta_{\textrm{off}}$ approaches $1/2(1+r)(1 - \Delta r)$ as $m \to \infty$. As such, when $r=1/2$ and $\Delta=1/2$, the maximum possible $\zeta_{\textrm{off}}$ is `r OffDelta(m=Inf, r=0.5, Delt=0.5, Beta=0)` (dashed curve) instead of `r OffDelta(m=Inf, r=0.5, Delt=0, Beta=0)` (solid curve). While this has no effect on optimal parental investment given that inbreeding has occurred, it should be noted that the existence of inbreeding depression that cannot be mitigated with parental investment might strongly affect the fitness consequences of inbreeding versus avoiding inbreeding (e.g., $\gamma^{*}_{r=1/2}$ versus $\gamma^{*}_{r=0}$).


******************************

References
----------------------------------------------


